

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="yhao521">
  <meta name="keywords" content="java,博客,vue,spring,mysql,docker,linux">
  
    <meta name="description" content="java bcprov 国密 依赖 jar包 版本 升级 降级 教程 更新记录 前言 一、org.bouncycastle下面的bcprov版本有哪些？ 二、升级降级说明  1、基线版本  （1）引入依赖 （2）关键代码  Cipher SM2 SM2Utils     2、版本区间1.48-1.59  （1）引入依赖 （2）关键代码  Cipher SM2 SM2Utils     3、版本区间">
<meta property="og:type" content="article">
<meta property="og:title" content="java bcprov 国密 依赖 jar包 版本 升级 降级 教程">
<meta property="og:url" content="https://yhao521.github.io/2025/07/23/%E6%91%98%E5%BD%95/java%20bcprov%20%E5%9B%BD%E5%AF%86%20%E4%BE%9D%E8%B5%96%20jar%E5%8C%85%20%E7%89%88%E6%9C%AC%20%E5%8D%87%E7%BA%A7%20%E9%99%8D%E7%BA%A7%20%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="匆匆过客的博客">
<meta property="og:description" content="java bcprov 国密 依赖 jar包 版本 升级 降级 教程 更新记录 前言 一、org.bouncycastle下面的bcprov版本有哪些？ 二、升级降级说明  1、基线版本  （1）引入依赖 （2）关键代码  Cipher SM2 SM2Utils     2、版本区间1.48-1.59  （1）引入依赖 （2）关键代码  Cipher SM2 SM2Utils     3、版本区间">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-07-23T12:01:27.000Z">
<meta property="article:modified_time" content="2025-01-14T18:08:12.000Z">
<meta property="article:author" content="yhao521">
<meta property="article:tag" content="java,博客,vue,spring,mysql,docker,linux">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>java bcprov 国密 依赖 jar包 版本 升级 降级 教程 - 匆匆过客的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yhao521.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>匆匆过客的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="java bcprov 国密 依赖 jar包 版本 升级 降级 教程"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-23 20:01" pubdate>
          2025年7月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          72 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">java bcprov 国密 依赖 jar包 版本 升级 降级 教程</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="java-bcprov-国密-依赖-jar包-版本-升级-降级-教程"><a href="#java-bcprov-国密-依赖-jar包-版本-升级-降级-教程" class="headerlink" title="java bcprov 国密 依赖 jar包 版本 升级 降级 教程"></a>java bcprov 国密 依赖 jar包 版本 升级 降级 教程</h4><ul>
<li><a href="#_6">更新记录</a></li>
<li><a href="#_43">前言</a></li>
<li><a href="#orgbouncycastlebcprov_54">一、org.bouncycastle下面的bcprov版本有哪些？</a></li>
<li><a href="#_102">二、升级降级说明</a></li>
<li><ul>
<li><a href="#1_104">1、基线版本</a></li>
<li><ul>
<li><a href="#1_106">（1）引入依赖</a></li>
<li><a href="#2_114">（2）关键代码</a></li>
<li><ul>
<li><a href="#Cipher_117">Cipher</a></li>
<li><a href="#SM2_225">SM2</a></li>
<li><a href="#SM2Utils_411">SM2Utils</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2148159_602">2、版本区间1.48-1.59</a></li>
<li><ul>
<li><a href="#1_604">（1）引入依赖</a></li>
<li><a href="#2_613">（2）关键代码</a></li>
<li><ul>
<li><a href="#Cipher_614">Cipher</a></li>
<li><a href="#SM2_617">SM2</a></li>
<li><a href="#SM2Utils_620">SM2Utils</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3138147_829">3、版本区间1.38-1.47</a></li>
<li><ul>
<li><a href="#1_831">（1）引入依赖</a></li>
<li><a href="#2_840">（2）关键代码</a></li>
<li><ul>
<li><a href="#Cipher_841">Cipher</a></li>
<li><a href="#SM2_843">SM2</a></li>
<li><a href="#SM2Utils_845">SM2Utils</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4150163_848">4、版本区间1.50-1.63</a></li>
<li><ul>
<li><a href="#1_850">（1）引入依赖</a></li>
<li><a href="#2_860">（2）关键代码</a></li>
<li><ul>
<li><a href="#Cipher_861">Cipher</a></li>
<li><a href="#SM2_970">SM2</a></li>
<li><a href="#SM2Utils_1171">SM2Utils</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5164175_1380">5、版本区间1.64-1.75</a></li>
<li><ul>
<li><a href="#1_1383">（1）引入依赖</a></li>
<li><a href="#2_1393">（2）关键代码</a></li>
<li><ul>
<li><a href="#Cipher_1394">Cipher</a></li>
<li><a href="#SM2_1502">SM2</a></li>
<li><a href="#SM2Utils_1750">SM2Utils</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_1974">总结</a></li>
</ul>
<hr>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p><em>2023-05-22<br>1、调整1.64-1.72区间代码，SM2和SM2Utils类，之前这个区间的代码贴成1.50-1.63区间的了，很抱歉。</em></p>
<hr>
<p><em>2023-06-27</em><br><em>1、“版本1.64-1.72区间”调整为”版本1.64-1.75区间”，博主实测以下代码兼容1.73-1.75版本。</em></p>
<p><em>2、增加1.73-1.75版本，且从1.74开始、不再支持jdk1.4版本，至少要jdk1.5及以上。</em></p>
<table>
<thead>
<tr>
<th>group-Id</th>
<th>artifact-Id</th>
<th>version</th>
<th>完整jar包名</th>
</tr>
</thead>
<tbody><tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.73</td>
<td>bcprov-jdk14-1.73.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.73.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.73.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.74</td>
<td>bcprov-jdk15to18-1.74.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.74.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.75</td>
<td>bcprov-jdk15to18-1.75.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.75.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<hr>
<p>*2024-03-19 *<br><em>1、增加1.76-1.77版本包，增加1.74-1.75的jdk1.4版本包，去年更新时候官方未提供支持jdk1.4版本，现在已支持，特此更新一版，所有版本看下方<strong>章节一</strong>中表格，后续新增的版本也不再更新记录中列举。</em></p>
<p><em>2、删除<strong>章节二-5</strong>中SM2类的多余代码，感谢<strong>阿凯同学-825</strong>在评论区指出。</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-comment">// 以下两行代码在try块中通过反射创建，故需注释</span><br>		<span class="hljs-comment">// this.ecc_gx_fieldelement = new Fp(this.ecc_p, this.ecc_gx);</span><br>		<span class="hljs-comment">// this.ecc_gy_fieldelement = new Fp(this.ecc_p, this.ecc_gy);</span><br>		<span class="hljs-comment">// 以下一行代码位置移动到try块中，故需注释</span><br>		<span class="hljs-comment">// this.ecc_curve = new ECCurve.Fp(this.ecc_p, this.ecc_a, this.ecc_b);</span><br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>关于java的国密算法原理以及<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=sm2&spm=1001.2101.3001.7020">sm2</a>、sm3、sm4的演示demo，很多博主都写过。但是如果说自身项目中用到的bcprov这个依赖jar包的版本，和别人博客里演示的不一样，或者说引用了多个版本bcprov的jar包，这种情况怎么办呢？</p>
<p>一般有两个方案，第一个是直接全部白嫖别人的版本，这种方案不是本文所讲内容。另一种方案就是弄明白每个版本依赖包的区别，这样我们的项目就可以只保留一个版本的依赖包了，而且想要留哪一个版本也不在话下。</p>
<p><strong>重要说明：</strong><br>在看代码前我做一些说明，bcprov这个包在高版本中增加了一些国密相关的签名或者加密类，但是为了兼容所有的版本，所以我并没有使用高版本中才有的类，而是根据比较低的基线版本上开发实现，基线版本代码链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/s78365126/article/details/83345954?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167143773916800192290181%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=167143773916800192290181&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-83345954-null-null.nonecase&utm_term=%E5%9B%BD%E5%AF%86%20bcprov%20DERInteger&spm=1018.2226.3001.4450">基于Java的（SM2_SM3_SM4）国密算法, 加密解密工具类及测试demo</a><br><strong>所以我在本博客中不会把所有的类代码都放上，只放关键的代码，如果有人因此喷我是cv党，那请自觉关闭本博客。</strong>  </p>
<hr>
<h2 id="一、org-bouncycastle下面的bcprov版本有哪些？"><a href="#一、org-bouncycastle下面的bcprov版本有哪些？" class="headerlink" title="一、org.bouncycastle下面的bcprov版本有哪些？"></a>一、org.bouncycastle下面的bcprov版本有哪些？</h2><p>从国内的某代理中央仓库里可以查到目前bcprov的版本参考下表。<br><strong>说明1</strong>：包名中jdk14的版本适用于jdk1.4，jdk15on的版本适用于jdk1.5以上，jdk15to18的版本适用于jdk1.5到jdk1.8，jdk18on的版本适用于jdk1.8以上，各位根据自己的jdk版本自行选择对应的版本。如果这说明不明白的可以在评论区提问。<br><strong>说明2</strong>：早期的bcprov版本号不一定是相连的，如果各位大佬使用的版本表格中，可以评论区提问或者私信。<br><strong>说明3</strong>：如果只用国密算法的sm2、<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=sm3&spm=1001.2101.3001.7020">sm3</a>、sm4，是不需要用到bcprov的ext包或者util包，只用核心包就可以了。</p>
<table>
<thead>
<tr>
<th>group-Id</th>
<th>artifact-Id</th>
<th>version</th>
<th>完整jar包名</th>
</tr>
</thead>
<tbody><tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15</td>
<td>1.32</td>
<td>bcprov-jdk15-1.32.jar</td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.38</td>
<td>bcprov-jdk14-1.38.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.38.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.38.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.40</td>
<td>bcprov-jdk15-1.40.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.40.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.43</td>
<td>bcprov-jdk14-1.43.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.43.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.43.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.44</td>
<td>bcprov-jdk14-1.44.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.44.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.44.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.44</td>
<td>bcprov-jdk14-1.44.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.44.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.44.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.45</td>
<td>bcprov-jdk14-1.45.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.45.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.45.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15+</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16</td>
<td>1.46</td>
<td>bcprov-jdk14-1.46.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15-1.46.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15±1.46.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.46.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.46.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.47</td>
<td>bcprov-jdk14-1.47.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.47.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.48</td>
<td>bcprov-jdk14-1.48.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.48.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.49</td>
<td>bcprov-jdk14-1.49.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.49.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.50</td>
<td>bcprov-jdk14-1.50.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.50.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.51</td>
<td>bcprov-jdk14-1.51.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.51.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15on</td>
<td>1.52</td>
<td>bcprov-jdk15on-1.52.jar</td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.53</td>
<td>bcprov-jdk14-1.53.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.53.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.54</td>
<td>bcprov-jdk14-1.54.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.54.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.55</td>
<td>bcprov-jdk14-1.55.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.55.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.56</td>
<td>bcprov-jdk14-1.56.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.56.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.57</td>
<td>bcprov-jdk14-1.57.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.57.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.58</td>
<td>bcprov-jdk14-1.58.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.58.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.59</td>
<td>bcprov-jdk14-1.59.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.59.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.60</td>
<td>bcprov-jdk14-1.60.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.60.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.61</td>
<td>bcprov-jdk14-1.61.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.61.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td>1.62</td>
<td>bcprov-jdk14-1.62.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.62.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.63</td>
<td>bcprov-jdk14-1.63.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.63.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.63.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.64</td>
<td>bcprov-jdk14-1.64.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.64.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.64.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.65</td>
<td>bcprov-jdk14-1.65.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.65.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.65.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.66</td>
<td>bcprov-jdk15-1.66.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk16-1.66.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.67</td>
<td>bcprov-jdk14-1.67.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.67.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.67.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.68</td>
<td>bcprov-jdk14-1.68.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.68.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.68.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.69</td>
<td>bcprov-jdk14-1.69.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.69.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.69.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td>1.70</td>
<td>bcprov-jdk14-1.70.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15on-1.70.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.70.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.71</td>
<td>bcprov-jdk14-1.71.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.71.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.71.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.72</td>
<td>bcprov-jdk14-1.72.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.72.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.72.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.73</td>
<td>bcprov-jdk14-1.73.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.73.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.73.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.74</td>
<td>bcprov-jdk14-1.74.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.74.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.74.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.75</td>
<td>bcprov-jdk14-1.75.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.75.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.75.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.76</td>
<td>bcprov-jdk14-1.76.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.76.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.76.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>org.bouncycastle</td>
<td>bcprov-jdk14</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on</td>
<td>1.77</td>
<td>bcprov-jdk14-1.77.jar</td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk15to18-1.77.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>bcprov-jdk18on-1.77.jar</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<hr>
<h2 id="二、升级降级说明"><a href="#二、升级降级说明" class="headerlink" title="二、升级降级说明"></a>二、升级降级说明</h2><p>上述表格中的版本，博主除了最老的1.32版本没有搞，其他的版本都测试过，测试使用的jdk1.8，其他版本jdk自行测试，下面会把上述jar包版本分成4个区间，也就是在区间内的任意一个版本都可以使用对应的代码。</p>
<h3 id="1、基线版本"><a href="#1、基线版本" class="headerlink" title="1、基线版本"></a>1、基线版本</h3><p>博客开头已经说明，博主原始国密算法实现用的bcprov版本是1.45，所以这里先展示基线的关键代码，方便各位对比。</p>
<h4 id="（1）引入依赖"><a href="#（1）引入依赖" class="headerlink" title="（1）引入依赖"></a>（1）引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk15on<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>12345<br></code></pre></td></tr></table></figure>

<h4 id="（2）关键代码"><a href="#（2）关键代码" class="headerlink" title="（2）关键代码"></a>（2）关键代码</h4><p>这里只放三个类的代码，Cipher、SM2和SM2Utils，对于不同版本bcprov最多只需要改这三个类，所以其他类就不贴了，各位要所有类的代码，看上述的链接就行。</p>
<h5 id="Cipher"><a href="#Cipher" class="headerlink" title="Cipher"></a>Cipher</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.crypto.AsymmetricCipherKeyPair;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPrivateKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPublicKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cipher</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> ct;<br>    <span class="hljs-keyword">private</span> ECPoint p2;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3keybase;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3c3;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] key;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span> keyOff;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cipher</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        <span class="hljs-built_in">this</span>.key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Reset</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3keybase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>        <span class="hljs-built_in">this</span>.sm3c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.getX().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>        p = Util.byteConvert32Bytes(p2.getY().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        NextKey();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">NextKey</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3keycur</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>(<span class="hljs-built_in">this</span>.sm3keybase);<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.doFinal(key, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.ct++;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ECPoint <span class="hljs-title function_">Init_enc</span><span class="hljs-params">(SM2 sm2, ECPoint userKey)</span><br>    &#123;<br>        <span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> sm2.ecc_key_pair_generator.generateKeyPair();<br>        <span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) key.getPrivate();<br>        <span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) key.getPublic();<br>        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> ecpriv.getD();<br>        <span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> ecpub.getQ();<br>        <span class="hljs-built_in">this</span>.p2 = userKey.multiply(k);<br>        Reset();<br>        <span class="hljs-keyword">return</span> c1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Encrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Init_dec</span><span class="hljs-params">(BigInteger userD, ECPoint c1)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.p2 = c1.multiply(userD);<br>        Reset();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Decrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Dofinal</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] c3)</span><br>    &#123;<br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.getY().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.doFinal(c3, <span class="hljs-number">0</span>);<br>        Reset();<br>    &#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2"><a href="#SM2" class="headerlink" title="SM2"></a>SM2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.crypto.AsymmetricCipherKeyPair;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.generators.ECKeyPairGenerator;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECDomainParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECKeyGenerationParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPrivateKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPublicKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECCurve;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECFieldElement;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECFieldElement.Fp;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.security.SecureRandom;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2</span><br>&#123;<br>	 <span class="hljs-comment">//测试参数</span><br><span class="hljs-comment">//	public static final String[] ecc_param = &#123;</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DE457283915C45517D722EDB8B08F1DFC3&quot;,</span><br><span class="hljs-comment">//			&quot;787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498&quot;,</span><br><span class="hljs-comment">//			&quot;63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A&quot;,</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DD297720630485628D5AE74EE7C32E79B7&quot;,</span><br><span class="hljs-comment">//			&quot;421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D&quot;,</span><br><span class="hljs-comment">//			&quot;0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2&quot;</span><br><span class="hljs-comment">//	&#125;;</span><br><br>	<span class="hljs-comment">// 正式参数 为国密算法推荐参数</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] ecc_param = &#123;<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>,<br>		<span class="hljs-string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>,<br>		<span class="hljs-string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>,<br>		<span class="hljs-string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span><br>	&#125;;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SM2 <span class="hljs-title function_">Instance</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2</span>();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_p;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_a;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_b;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_n;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gx;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gy;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECCurve ecc_curve;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECPoint ecc_point_g;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECDomainParameters ecc_bc_spec;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECKeyPairGenerator ecc_key_pair_generator;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gx_fieldelement;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gy_fieldelement;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">SM2</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-built_in">this</span>.ecc_p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">2</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_n = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">3</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">4</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">5</span>], <span class="hljs-number">16</span>);<br><br>		<span class="hljs-built_in">this</span>.ecc_gx_fieldelement = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fp</span>(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_gx);<br>		<span class="hljs-built_in">this</span>.ecc_gy_fieldelement = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fp</span>(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_gy);<br><br>		<span class="hljs-built_in">this</span>.ecc_curve = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECCurve</span>.Fp(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_a, <span class="hljs-built_in">this</span>.ecc_b);<br>		<span class="hljs-built_in">this</span>.ecc_point_g = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECPoint</span>.Fp(<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_gx_fieldelement, <span class="hljs-built_in">this</span>.ecc_gy_fieldelement);<br><br>		<span class="hljs-built_in">this</span>.ecc_bc_spec = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECDomainParameters</span>(<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_point_g, <span class="hljs-built_in">this</span>.ecc_n);<br><br>		ECKeyGenerationParameters ecc_ecgenparam;<br>		ecc_ecgenparam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyGenerationParameters</span>(<span class="hljs-built_in">this</span>.ecc_bc_spec, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>());<br><br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyPairGenerator</span>();<br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator.init(ecc_ecgenparam);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] sm2GetZ(<span class="hljs-type">byte</span>[] userId, ECPoint userKey)<br>	&#123;<br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>		<span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> userId.length * <span class="hljs-number">8</span>;<br>		sm3.update((<span class="hljs-type">byte</span>) (len &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update((<span class="hljs-type">byte</span>) (len &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update(userId, <span class="hljs-number">0</span>, userId.length);<br><br>		<span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(ecc_a);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_b);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gx);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gy);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.getX().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.getY().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[sm3.getDigestSize()];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> md;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, BigInteger userD, ECPoint userKey, SM2Result sm2Result)</span><br>	&#123;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">do</span><br>		&#123;<br>			<span class="hljs-keyword">do</span><br>			&#123;<br>				<span class="hljs-comment">// 正式环境</span><br>				<span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">keypair</span> <span class="hljs-operator">=</span> ecc_key_pair_generator.generateKeyPair();<br>				<span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) keypair.getPrivate();<br>				<span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) keypair.getPublic();<br>				k = ecpriv.getD();<br>				kp = ecpub.getQ();<br><br>				<span class="hljs-comment">// 国密规范测试 随机数k</span><br><span class="hljs-comment">//				String kS = &quot;6CB28D99385C175C94F94E934817663FC176D925DD72B727260DBAAE1FB2F96F&quot;;</span><br><span class="hljs-comment">//				k = new BigInteger(kS, 16);</span><br><span class="hljs-comment">//				kp = this.ecc_point_g.multiply(k);</span><br><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点X1: &quot; + kp.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点Y1: &quot; + kp.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;&quot;);</span><br><br>				<span class="hljs-comment">// r</span><br>				r = e.add(kp.getX().toBigInteger());<br>				r = r.mod(ecc_n);<br>			&#125; <span class="hljs-keyword">while</span> (r.equals(BigInteger.ZERO) || r.add(k).equals(ecc_n));<br><br>			<span class="hljs-comment">// (1 + dA)~-1</span><br>			<span class="hljs-type">BigInteger</span> <span class="hljs-variable">da_1</span> <span class="hljs-operator">=</span> userD.add(BigInteger.ONE);<br>			da_1 = da_1.modInverse(ecc_n);<br><br>			<span class="hljs-comment">// s</span><br>			s = r.multiply(userD);<br>			s = k.subtract(s).mod(ecc_n);<br>			s = da_1.multiply(s).mod(ecc_n);<br>		&#125; <span class="hljs-keyword">while</span> (s.equals(BigInteger.ZERO));<br><br>		sm2Result.r = r;<br>		sm2Result.s = s;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Verify</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, ECPoint userKey, BigInteger r, BigInteger s, SM2Result sm2Result)</span><br>	&#123;<br>		sm2Result.R = <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> r.add(s).mod(ecc_n);<br>		<span class="hljs-keyword">if</span>(t.equals(BigInteger.ZERO))<br>		&#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			<span class="hljs-type">ECPoint</span> <span class="hljs-variable">x1y1</span> <span class="hljs-operator">=</span> ecc_point_g.multiply(sm2Result.s);<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X0: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y0: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br><br>			x1y1 = x1y1.add(userKey.multiply(t));<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X1: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y1: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br>			sm2Result.R = e.add(x1y1.getX().toBigInteger()).mod(ecc_n);<br>			System.out.println(<span class="hljs-string">&quot;R: &quot;</span> + sm2Result.R.toString(<span class="hljs-number">16</span>));<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2Utils"><a href="#SM2Utils" class="headerlink" title="SM2Utils"></a>SM2Utils</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.asn1.*;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2Utils</span><br>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] data) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span> || data.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length];<br>		System.arraycopy(data, <span class="hljs-number">0</span>, source, <span class="hljs-number">0</span>, data.length);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> cipher.Init_enc(sm2, userKey);<br>		cipher.Encrypt(source);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.getX().toBigInteger());<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.getY().toBigInteger());<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derDig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(c3);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derEnc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(source);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v.add(x);<br>		v.add(y);<br>		v.add(derDig);<br>		v.add(derEnc);<br>		<span class="hljs-type">DERSequence</span> <span class="hljs-variable">seq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v);<br>		<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>		<span class="hljs-type">DEROutputStream</span> <span class="hljs-variable">dos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROutputStream</span>(bos);<br>		dos.writeObject(seq);<br>		<span class="hljs-keyword">return</span> bos.toByteArray();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] encryptedData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (encryptedData == <span class="hljs-literal">null</span> || encryptedData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] enc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptedData.length];<br>		System.arraycopy(encryptedData, <span class="hljs-number">0</span>, enc, <span class="hljs-number">0</span>, encryptedData.length);<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, privateKey);<br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(enc);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-type">DERObject</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> dis.readObject();<br>		<span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">asn1</span> <span class="hljs-operator">=</span> (ASN1Sequence) derObj;<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (DERInteger) asn1.getObjectAt(<span class="hljs-number">0</span>);<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (DERInteger) asn1.getObjectAt(<span class="hljs-number">1</span>);<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> sm2.ecc_curve.createPoint(x.getValue(), y.getValue(), <span class="hljs-literal">true</span>);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		cipher.Init_dec(userD, c1);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (DEROctetString) asn1.getObjectAt(<span class="hljs-number">3</span>);<br>		enc = data.getOctets();<br>		cipher.Decrypt(enc);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br>		<span class="hljs-keyword">return</span> enc;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] sign(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] sourceData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(privateKey);<br><span class="hljs-comment">//		System.out.println(&quot;userD: &quot; + userD.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_point_g.multiply(userD);<br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点X: &quot; + userKey.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点Y: &quot; + userKey.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要Z: &quot; + Util.getHexString(z));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//		System.out.println(&quot;M: &quot; + Util.getHexString(sourceData));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2.sm2Sign(md, userD, userKey, sm2Result);<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.r);<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.s);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v2.add(d_r);<br>		v2.add(d_s);<br>		<span class="hljs-type">DERObject</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v2);<br>		<span class="hljs-type">byte</span>[] signdata = sign.getDEREncoded();<br>		<span class="hljs-keyword">return</span> signdata;<br>	&#125;<br><br>	<span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] sourceData, <span class="hljs-type">byte</span>[] signData)</span> <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		System.out.println(<span class="hljs-string">&quot;SM3摘要值: &quot;</span> + Util.getHexString(md));<br>		System.out.println();<br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(signData);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-type">DERObject</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> dis.readObject();<br>		Enumeration&lt;DERInteger&gt; e = ((ASN1Sequence) derObj).getObjects();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2Result.r = r;<br>		sm2Result.s = s;<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br><br>		sm2.sm2Verify(md, userKey, sm2Result.r, sm2Result.s, sm2Result);<br>		<span class="hljs-keyword">return</span> sm2Result.r.equals(sm2Result.R);<br>	&#125;<br><br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185</span><br></code></pre></td></tr></table></figure>

<h3 id="2、版本区间1-48-1-59"><a href="#2、版本区间1-48-1-59" class="headerlink" title="2、版本区间1.48-1.59"></a>2、版本区间1.48-1.59</h3><p>之所以先写这个版本区间，是因为博主一开始用的版本是1.45改的1.55，所以就讲这个。各位使用的bcprov的版本在1.49到1.59之间都可以参考。</p>
<h4 id="（1）引入依赖-1"><a href="#（1）引入依赖-1" class="headerlink" title="（1）引入依赖"></a>（1）引入依赖</h4><p>我只演示区间内的其中一个版本，其他版本可自行替换测试，注意jdk版本。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk15on<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.55<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>12345<br></code></pre></td></tr></table></figure>

<h4 id="（2）关键代码-1"><a href="#（2）关键代码-1" class="headerlink" title="（2）关键代码"></a>（2）关键代码</h4><h5 id="Cipher-1"><a href="#Cipher-1" class="headerlink" title="Cipher"></a>Cipher</h5><p>同基线版本就可以，不再重复。</p>
<h5 id="SM2-1"><a href="#SM2-1" class="headerlink" title="SM2"></a>SM2</h5><p>同基线版本就可以，不再重复。</p>
<h5 id="SM2Utils-1"><a href="#SM2Utils-1" class="headerlink" title="SM2Utils"></a>SM2Utils</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.logging.Log;<br><span class="hljs-keyword">import</span> org.apache.commons.logging.LogFactory;<br><span class="hljs-keyword">import</span> org.bouncycastle.asn1.*;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2Utils</span><br>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(SM2Utils.class);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] data) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span> || data.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length];<br>		System.arraycopy(data, <span class="hljs-number">0</span>, source, <span class="hljs-number">0</span>, data.length);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> cipher.Init_enc(sm2, userKey);<br>		cipher.Encrypt(source);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.getX().toBigInteger());<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.getY().toBigInteger());<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derDig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(c3);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derEnc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(source);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v.add(x);<br>		v.add(y);<br>		v.add(derDig);<br>		v.add(derEnc);<br>		<span class="hljs-type">DERSequence</span> <span class="hljs-variable">seq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v);<br>		<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>		<span class="hljs-type">DEROutputStream</span> <span class="hljs-variable">dos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROutputStream</span>(bos);<br>		dos.writeObject(seq);<br>		<span class="hljs-keyword">return</span> bos.toByteArray();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] encryptedData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (encryptedData == <span class="hljs-literal">null</span> || encryptedData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] enc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptedData.length];<br>		System.arraycopy(encryptedData, <span class="hljs-number">0</span>, enc, <span class="hljs-number">0</span>, encryptedData.length);<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, privateKey);<br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(enc);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object代替DERObject，ASN1Integer代替DERInteger</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// ASN1Sequence asn1 = (ASN1Sequence) derObj;</span><br>		<span class="hljs-comment">// DERInteger x = (DERInteger) asn1.getObjectAt(0);</span><br>		<span class="hljs-comment">// DERInteger y = (DERInteger) asn1.getObjectAt(1);</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		<span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">asn1</span> <span class="hljs-operator">=</span> (ASN1Sequence) derObj;<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">0</span>);<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">1</span>);<br>		<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> sm2.ecc_curve.createPoint(x.getValue(), y.getValue(), <span class="hljs-literal">true</span>);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		cipher.Init_dec(userD, c1);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (DEROctetString) asn1.getObjectAt(<span class="hljs-number">3</span>);<br>		enc = data.getOctets();<br>		cipher.Decrypt(enc);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br>		<span class="hljs-keyword">return</span> enc;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] sign(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] sourceData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(privateKey);<br><span class="hljs-comment">//		System.out.println(&quot;userD: &quot; + userD.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_point_g.multiply(userD);<br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点X: &quot; + userKey.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点Y: &quot; + userKey.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要Z: &quot; + Util.getHexString(z));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//		System.out.println(&quot;M: &quot; + Util.getHexString(sourceData));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2.sm2Sign(md, userD, userKey, sm2Result);<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.r);<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.s);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v2.add(d_r);<br>		v2.add(d_s);<br>		<span class="hljs-comment">// 调整DER编码的写法</span><br>		<span class="hljs-comment">// DERObject sign = new DERSequence(v2);</span><br>		<span class="hljs-comment">// byte[] signdata = sign.getDEREncoded();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v2);<br>		<span class="hljs-type">byte</span>[] signdata = sign.getEncoded(<span class="hljs-string">&quot;DER&quot;</span>);<br>		<br>		<span class="hljs-keyword">return</span> signdata;<br>	&#125;<br><br>	<span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] sourceData, <span class="hljs-type">byte</span>[] signData)</span> <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">if</span> (log.isInfoEnabled())&#123;<br>			log.info(<span class="hljs-string">&quot;SM3摘要值: &quot;</span> + Util.getHexString(md));<br>		&#125;<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println();</span><br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(signData);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object替换DERObject，ASN1Integer替换DERInteger</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// Enumeration&lt;DERInteger&gt; e = ((ASN1Sequence) derObj).getObjects();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		Enumeration&lt;ASN1Integer&gt; e = ((ASN1Sequence) derObj).getObjects();<br>		<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2Result.r = r;<br>		sm2Result.s = s;<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br><br>		sm2.sm2Verify(md, userKey, sm2Result.r, sm2Result.s, sm2Result);<br>		<span class="hljs-keyword">return</span> sm2Result.r.equals(sm2Result.R);<br>	&#125;<br><br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205</span><br></code></pre></td></tr></table></figure>

<h3 id="3、版本区间1-38-1-47"><a href="#3、版本区间1-38-1-47" class="headerlink" title="3、版本区间1.38-1.47"></a>3、版本区间1.38-1.47</h3><p>仓库不存在1.39、1.41和1.42版本，另外1.32无法适配，这个问题在上面也有说过，如果想用1.32版本但是不会降级的小伙伴也可以评论区咨询。</p>
<h4 id="（1）引入依赖-2"><a href="#（1）引入依赖-2" class="headerlink" title="（1）引入依赖"></a>（1）引入依赖</h4><p>我只演示区间内的其中一个版本，其他版本可自行替换测试，注意jdk版本。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk15<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.45<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>12345<br></code></pre></td></tr></table></figure>

<h4 id="（2）关键代码-2"><a href="#（2）关键代码-2" class="headerlink" title="（2）关键代码"></a>（2）关键代码</h4><h5 id="Cipher-2"><a href="#Cipher-2" class="headerlink" title="Cipher"></a>Cipher</h5><p>同基线版本就可以，不再重复。</p>
<h5 id="SM2-2"><a href="#SM2-2" class="headerlink" title="SM2"></a>SM2</h5><p>同基线版本就可以，不再重复。</p>
<h5 id="SM2Utils-2"><a href="#SM2Utils-2" class="headerlink" title="SM2Utils"></a>SM2Utils</h5><p>同基线版本就可以，不再重复。</p>
<h3 id="4、版本区间1-50-1-63"><a href="#4、版本区间1-50-1-63" class="headerlink" title="4、版本区间1.50-1.63"></a>4、版本区间1.50-1.63</h3><p>有些小伙伴可能会很奇怪，上面1.49-1.59不是包含了1.48-1.59了吗，为什么这里还有呢？其实也很好理解，毕竟实现方法不止一种，所以说版本在1.50-1.59之间的可以用上面的方法，也可以用这里的方法。</p>
<h4 id="（1）引入依赖-3"><a href="#（1）引入依赖-3" class="headerlink" title="（1）引入依赖"></a>（1）引入依赖</h4><p>我只演示区间内的其中一个版本，其他版本可自行替换测试，注意jdk版本。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk15on<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.60<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>12345<br></code></pre></td></tr></table></figure>

<h4 id="（2）关键代码-3"><a href="#（2）关键代码-3" class="headerlink" title="（2）关键代码"></a>（2）关键代码</h4><h5 id="Cipher-3"><a href="#Cipher-3" class="headerlink" title="Cipher"></a>Cipher</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.crypto.AsymmetricCipherKeyPair;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPrivateKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPublicKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cipher</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> ct;<br>    <span class="hljs-keyword">private</span> ECPoint p2;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3keybase;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3c3;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] key;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span> keyOff;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cipher</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        <span class="hljs-built_in">this</span>.key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Reset</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3keybase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>        <span class="hljs-built_in">this</span>.sm3c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.normalize().getXCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>        p = Util.byteConvert32Bytes(p2.normalize().getYCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        NextKey();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">NextKey</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3keycur</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>(<span class="hljs-built_in">this</span>.sm3keybase);<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.doFinal(key, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.ct++;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ECPoint <span class="hljs-title function_">Init_enc</span><span class="hljs-params">(SM2 sm2, ECPoint userKey)</span><br>    &#123;<br>        <span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> sm2.ecc_key_pair_generator.generateKeyPair();<br>        <span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) key.getPrivate();<br>        <span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) key.getPublic();<br>        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> ecpriv.getD();<br>        <span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> ecpub.getQ();<br>        <span class="hljs-built_in">this</span>.p2 = userKey.multiply(k);<br>        Reset();<br>        <span class="hljs-keyword">return</span> c1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Encrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Init_dec</span><span class="hljs-params">(BigInteger userD, ECPoint c1)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.p2 = c1.multiply(userD);<br>        Reset();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Decrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Dofinal</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] c3)</span><br>    &#123;<br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.normalize().getYCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.doFinal(c3, <span class="hljs-number">0</span>);<br>        Reset();<br>    &#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2-3"><a href="#SM2-3" class="headerlink" title="SM2"></a>SM2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.security.SecureRandom;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2</span><br>&#123;<br>	 <span class="hljs-comment">//测试参数</span><br><span class="hljs-comment">//	public static final String[] ecc_param = &#123;</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DE457283915C45517D722EDB8B08F1DFC3&quot;,</span><br><span class="hljs-comment">//			&quot;787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498&quot;,</span><br><span class="hljs-comment">//			&quot;63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A&quot;,</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DD297720630485628D5AE74EE7C32E79B7&quot;,</span><br><span class="hljs-comment">//			&quot;421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D&quot;,</span><br><span class="hljs-comment">//			&quot;0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2&quot;</span><br><span class="hljs-comment">//	&#125;;</span><br><br>	<span class="hljs-comment">// 正式参数 为国密算法推荐参数</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] ecc_param = &#123;<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>,<br>		<span class="hljs-string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>,<br>		<span class="hljs-string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>,<br>		<span class="hljs-string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span><br>	&#125;;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SM2 <span class="hljs-title function_">Instance</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2</span>();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_p;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_a;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_b;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_n;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gx;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gy;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECCurve ecc_curve;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECPoint ecc_point_g;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECDomainParameters ecc_bc_spec;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECKeyPairGenerator ecc_key_pair_generator;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gx_fieldelement;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gy_fieldelement;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">SM2</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-built_in">this</span>.ecc_p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">2</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_n = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">3</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">4</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">5</span>], <span class="hljs-number">16</span>);<br><br>		<span class="hljs-built_in">this</span>.ecc_gx_fieldelement = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fp</span>(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_gx);<br>		<span class="hljs-built_in">this</span>.ecc_gy_fieldelement = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fp</span>(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_gy);<br><br>		<span class="hljs-built_in">this</span>.ecc_curve = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECCurve</span>.Fp(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_a, <span class="hljs-built_in">this</span>.ecc_b);<br>		<span class="hljs-comment">// 使用反射调用方法</span><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">ecc_point_g1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// 此区间的bcprov版本的构造方法是私有的，无法直接new，只能通过反射来调用构造方法</span><br>			<span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ECPoint.Fp.class;<br>			<span class="hljs-comment">/*以下调用带参的、私有构造函数*/</span><br>			<span class="hljs-type">Constructor</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ECCurve.class, ECFieldElement.class, ECFieldElement.class, <span class="hljs-type">boolean</span>.class&#125;);<br>			c1.setAccessible(<span class="hljs-literal">true</span>);<br>			ecc_point_g1 = (ECPoint.Fp)c1.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_gx_fieldelement, <span class="hljs-built_in">this</span>.ecc_gy_fieldelement, <span class="hljs-literal">false</span>&#125;);<br>		&#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-built_in">this</span>.ecc_point_g = ecc_point_g1;<br>		<br>		<span class="hljs-built_in">this</span>.ecc_bc_spec = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECDomainParameters</span>(<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_point_g, <span class="hljs-built_in">this</span>.ecc_n);<br><br>		ECKeyGenerationParameters ecc_ecgenparam;<br>		ecc_ecgenparam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyGenerationParameters</span>(<span class="hljs-built_in">this</span>.ecc_bc_spec, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>());<br><br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyPairGenerator</span>();<br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator.init(ecc_ecgenparam);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] sm2GetZ(<span class="hljs-type">byte</span>[] userId, ECPoint userKey)<br>	&#123;<br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>		<span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> userId.length * <span class="hljs-number">8</span>;<br>		sm3.update((<span class="hljs-type">byte</span>) (len &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update((<span class="hljs-type">byte</span>) (len &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update(userId, <span class="hljs-number">0</span>, userId.length);<br><br>		<span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(ecc_a);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_b);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gx);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gy);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.normalize().getXCoord().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.normalize().getYCoord().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[sm3.getDigestSize()];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> md;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, BigInteger userD, ECPoint userKey, SM2Result sm2Result)</span><br>	&#123;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">do</span><br>		&#123;<br>			<span class="hljs-keyword">do</span><br>			&#123;<br>				<span class="hljs-comment">// 正式环境</span><br>				<span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">keypair</span> <span class="hljs-operator">=</span> ecc_key_pair_generator.generateKeyPair();<br>				<span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) keypair.getPrivate();<br>				<span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) keypair.getPublic();<br>				k = ecpriv.getD();<br>				kp = ecpub.getQ();<br><br>				<span class="hljs-comment">// 国密规范测试 随机数k</span><br><span class="hljs-comment">//				String kS = &quot;6CB28D99385C175C94F94E934817663FC176D925DD72B727260DBAAE1FB2F96F&quot;;</span><br><span class="hljs-comment">//				k = new BigInteger(kS, 16);</span><br><span class="hljs-comment">//				kp = this.ecc_point_g.multiply(k);</span><br><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点X1: &quot; + kp.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点Y1: &quot; + kp.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;&quot;);</span><br><br>				<span class="hljs-comment">// r</span><br>				r = e.add(kp.normalize().getXCoord().toBigInteger());<br>				r = r.mod(ecc_n);<br>			&#125; <span class="hljs-keyword">while</span> (r.equals(BigInteger.ZERO) || r.add(k).equals(ecc_n));<br><br>			<span class="hljs-comment">// (1 + dA)~-1</span><br>			<span class="hljs-type">BigInteger</span> <span class="hljs-variable">da_1</span> <span class="hljs-operator">=</span> userD.add(BigInteger.ONE);<br>			da_1 = da_1.modInverse(ecc_n);<br><br>			<span class="hljs-comment">// s</span><br>			s = r.multiply(userD);<br>			s = k.subtract(s).mod(ecc_n);<br>			s = da_1.multiply(s).mod(ecc_n);<br>		&#125; <span class="hljs-keyword">while</span> (s.equals(BigInteger.ZERO));<br><br>		sm2Result.r = r;<br>		sm2Result.s = s;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Verify</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, ECPoint userKey, BigInteger r, BigInteger s, SM2Result sm2Result)</span><br>	&#123;<br>		sm2Result.R = <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> r.add(s).mod(ecc_n);<br>		<span class="hljs-keyword">if</span>(t.equals(BigInteger.ZERO))<br>		&#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			<span class="hljs-type">ECPoint</span> <span class="hljs-variable">x1y1</span> <span class="hljs-operator">=</span> ecc_point_g.multiply(sm2Result.s);<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X0: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y0: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br><br>			x1y1 = x1y1.add(userKey.multiply(t));<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X1: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y1: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br>			sm2Result.R = e.add(x1y1.normalize().getXCoord().toBigInteger()).mod(ecc_n);<br><span class="hljs-comment">//			System.out.println(&quot;R: &quot; + sm2Result.R.toString(16));</span><br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2Utils-3"><a href="#SM2Utils-3" class="headerlink" title="SM2Utils"></a>SM2Utils</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.logging.Log;<br><span class="hljs-keyword">import</span> org.apache.commons.logging.LogFactory;<br><span class="hljs-keyword">import</span> org.bouncycastle.asn1.*;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2Utils</span><br>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(SM2Utils.class);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] data) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span> || data.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length];<br>		System.arraycopy(data, <span class="hljs-number">0</span>, source, <span class="hljs-number">0</span>, data.length);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> cipher.Init_enc(sm2, userKey);<br>		cipher.Encrypt(source);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.normalize().getXCoord().toBigInteger());<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(c1.normalize().getYCoord().toBigInteger());<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derDig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(c3);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derEnc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(source);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v.add(x);<br>		v.add(y);<br>		v.add(derDig);<br>		v.add(derEnc);<br>		<span class="hljs-type">DERSequence</span> <span class="hljs-variable">seq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v);<br>		<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>		<span class="hljs-type">DEROutputStream</span> <span class="hljs-variable">dos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROutputStream</span>(bos);<br>		dos.writeObject(seq);<br>		<span class="hljs-keyword">return</span> bos.toByteArray();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] encryptedData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (encryptedData == <span class="hljs-literal">null</span> || encryptedData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] enc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptedData.length];<br>		System.arraycopy(encryptedData, <span class="hljs-number">0</span>, enc, <span class="hljs-number">0</span>, encryptedData.length);<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, privateKey);<br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(enc);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object代替DERObject，ASN1Integer代替ASN1Object</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// ASN1Sequence asn1 = (ASN1Sequence) derObj;</span><br>		<span class="hljs-comment">// DERInteger x = (DERInteger) asn1.getObjectAt(0);</span><br>		<span class="hljs-comment">// DERInteger y = (DERInteger) asn1.getObjectAt(1);</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		<span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">asn1</span> <span class="hljs-operator">=</span> (ASN1Sequence) derObj;<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">0</span>);<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">1</span>);<br>		<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> sm2.ecc_curve.createPoint(x.getValue(), y.getValue());<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		cipher.Init_dec(userD, c1);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (DEROctetString) asn1.getObjectAt(<span class="hljs-number">3</span>);<br>		enc = data.getOctets();<br>		cipher.Decrypt(enc);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br>		<span class="hljs-keyword">return</span> enc;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] sign(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] sourceData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(privateKey);<br><span class="hljs-comment">//		System.out.println(&quot;userD: &quot; + userD.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_point_g.multiply(userD);<br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点X: &quot; + userKey.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点Y: &quot; + userKey.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要Z: &quot; + Util.getHexString(z));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//		System.out.println(&quot;M: &quot; + Util.getHexString(sourceData));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2.sm2Sign(md, userD, userKey, sm2Result);<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.r);<br>		<span class="hljs-type">DERInteger</span> <span class="hljs-variable">d_s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERInteger</span>(sm2Result.s);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v2.add(d_r);<br>		v2.add(d_s);<br>		<span class="hljs-comment">// 调整DER编码的写法</span><br>		<span class="hljs-comment">// DERObject sign = new DERSequence(v2);</span><br>		<span class="hljs-comment">// byte[] signdata = sign.getDEREncoded();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v2);<br>		<span class="hljs-type">byte</span>[] signdata = sign.getEncoded(<span class="hljs-string">&quot;DER&quot;</span>);<br>		<br>		<span class="hljs-keyword">return</span> signdata;<br>	&#125;<br><br>	<span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] sourceData, <span class="hljs-type">byte</span>[] signData)</span> <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">if</span> (log.isDebugEnabled())&#123;<br>			log.debug(<span class="hljs-string">&quot;SM3摘要值: &quot;</span> + Util.getHexString(md));<br>		&#125;<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println();</span><br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(signData);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object替换DERObject，ASN1Integer替换DERInteger</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// Enumeration&lt;DERInteger&gt; e = ((ASN1Sequence) derObj).getObjects();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		Enumeration&lt;ASN1Integer&gt; e = ((ASN1Sequence) derObj).getObjects();<br>		<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2Result.r = r;<br>		sm2Result.s = s;<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		sm2.sm2Verify(md, userKey, sm2Result.r, sm2Result.s, sm2Result);<br>		<span class="hljs-keyword">return</span> sm2Result.r.equals(sm2Result.R);<br>	&#125;<br><br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204</span><br></code></pre></td></tr></table></figure>

<h3 id="5、版本区间1-64-1-75"><a href="#5、版本区间1-64-1-75" class="headerlink" title="5、版本区间1.64-1.75"></a>5、版本区间1.64-1.75</h3><h4 id="（1）引入依赖-4"><a href="#（1）引入依赖-4" class="headerlink" title="（1）引入依赖"></a>（1）引入依赖</h4><p>我只演示区间内的其中一个版本，其他版本可自行替换测试，注意jdk版本。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml">        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.bouncycastle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bcprov-jdk15on<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.64<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>12345<br></code></pre></td></tr></table></figure>

<h4 id="（2）关键代码-4"><a href="#（2）关键代码-4" class="headerlink" title="（2）关键代码"></a>（2）关键代码</h4><h5 id="Cipher-4"><a href="#Cipher-4" class="headerlink" title="Cipher"></a>Cipher</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.crypto.AsymmetricCipherKeyPair;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPrivateKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPublicKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cipher</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> ct;<br>    <span class="hljs-keyword">private</span> ECPoint p2;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3keybase;<br>    <span class="hljs-keyword">private</span> SM3Digest sm3c3;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] key;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span> keyOff;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cipher</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        <span class="hljs-built_in">this</span>.key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Reset</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3keybase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>        <span class="hljs-built_in">this</span>.sm3c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.normalize().getXCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>        p = Util.byteConvert32Bytes(p2.normalize().getYCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3keybase.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.ct = <span class="hljs-number">1</span>;<br>        NextKey();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">NextKey</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3keycur</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>(<span class="hljs-built_in">this</span>.sm3keybase);<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">24</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">16</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.update((<span class="hljs-type">byte</span>) (ct &amp; <span class="hljs-number">0xff</span>));<br>        sm3keycur.doFinal(key, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">this</span>.keyOff = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">this</span>.ct++;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ECPoint <span class="hljs-title function_">Init_enc</span><span class="hljs-params">(SM2 sm2, ECPoint userKey)</span><br>    &#123;<br>        <span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> sm2.ecc_key_pair_generator.generateKeyPair();<br>        <span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) key.getPrivate();<br>        <span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) key.getPublic();<br>        <span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> ecpriv.getD();<br>        <span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> ecpub.getQ();<br>        <span class="hljs-built_in">this</span>.p2 = userKey.multiply(k);<br>        Reset();<br>        <span class="hljs-keyword">return</span> c1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Encrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Init_dec</span><span class="hljs-params">(BigInteger userD, ECPoint c1)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.p2 = c1.multiply(userD);<br>        Reset();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Decrypt</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (keyOff == key.length)<br>            &#123;<br>                NextKey();<br>            &#125;<br>            data[i] ^= key[keyOff++];<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.sm3c3.update(data, <span class="hljs-number">0</span>, data.length);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Dofinal</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] c3)</span><br>    &#123;<br>        <span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(p2.normalize().getYCoord().toBigInteger());<br>        <span class="hljs-built_in">this</span>.sm3c3.update(p, <span class="hljs-number">0</span>, p.length);<br>        <span class="hljs-built_in">this</span>.sm3c3.doFinal(c3, <span class="hljs-number">0</span>);<br>        Reset();<br>    &#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2-4"><a href="#SM2-4" class="headerlink" title="SM2"></a>SM2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.bouncycastle.crypto.AsymmetricCipherKeyPair;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.generators.ECKeyPairGenerator;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECDomainParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECKeyGenerationParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPrivateKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.crypto.params.ECPublicKeyParameters;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECCurve;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECFieldElement;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECFieldElement.Fp;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.security.SecureRandom;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2</span><br>&#123;<br>	 <span class="hljs-comment">//测试参数</span><br><span class="hljs-comment">//	public static final String[] ecc_param = &#123;</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DE457283915C45517D722EDB8B08F1DFC3&quot;,</span><br><span class="hljs-comment">//			&quot;787968B4FA32C3FD2417842E73BBFEFF2F3C848B6831D7E0EC65228B3937E498&quot;,</span><br><span class="hljs-comment">//			&quot;63E4C6D3B23B0C849CF84241484BFE48F61D59A5B16BA06E6E12D1DA27C5249A&quot;,</span><br><span class="hljs-comment">//			&quot;8542D69E4C044F18E8B92435BF6FF7DD297720630485628D5AE74EE7C32E79B7&quot;,</span><br><span class="hljs-comment">//			&quot;421DEBD61B62EAB6746434EBC3CC315E32220B3BADD50BDC4C4E6C147FEDD43D&quot;,</span><br><span class="hljs-comment">//			&quot;0680512BCBB42C07D47349D2153B70C4E5D7FDFCBFA36EA1A85841B9E46E09A2&quot;</span><br><span class="hljs-comment">//	&#125;;</span><br><br>	<span class="hljs-comment">// 正式参数 为国密算法推荐参数</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] ecc_param = &#123;<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>,<br>		<span class="hljs-string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>,<br>		<span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>,<br>		<span class="hljs-string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>,<br>		<span class="hljs-string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span><br>	&#125;;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SM2 <span class="hljs-title function_">Instance</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2</span>();<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_p;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_a;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_b;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_n;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gx;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> BigInteger ecc_gy;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECCurve ecc_curve;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECPoint ecc_point_g;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECDomainParameters ecc_bc_spec;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECKeyPairGenerator ecc_key_pair_generator;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gx_fieldelement;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ECFieldElement ecc_gy_fieldelement;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">SM2</span><span class="hljs-params">()</span><br>	&#123;<br>		<span class="hljs-built_in">this</span>.ecc_p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">2</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_n = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">3</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">4</span>], <span class="hljs-number">16</span>);<br>		<span class="hljs-built_in">this</span>.ecc_gy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(ecc_param[<span class="hljs-number">5</span>], <span class="hljs-number">16</span>);<br><br>        <span class="hljs-comment">// 以下两行代码在try块中通过反射创建，故需注释</span><br>		<span class="hljs-comment">// this.ecc_gx_fieldelement = new Fp(this.ecc_p, this.ecc_gx);</span><br>		<span class="hljs-comment">// this.ecc_gy_fieldelement = new Fp(this.ecc_p, this.ecc_gy);</span><br>		<br>		<span class="hljs-comment">// 以下一行代码位置移动到try块中，故需注释</span><br>		<span class="hljs-comment">// this.ecc_curve = new ECCurve.Fp(this.ecc_p, this.ecc_a, this.ecc_b);</span><br>		<br>		<span class="hljs-comment">// 使用反射调用方法</span><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">ecc_point_g1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// 此区间的bcprov版本的构造方法是私有的，无法直接new，只能通过反射来调用构造方法</span><br>			<span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ECPoint.Fp.class;<br>			<span class="hljs-comment">/*以下调用带参的、私有构造函数*/</span><br>			<span class="hljs-type">Constructor</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ECCurve.class, ECFieldElement.class, ECFieldElement.class&#125;);<br>			c1.setAccessible(<span class="hljs-literal">true</span>);<br>			<span class="hljs-type">Class</span> <span class="hljs-variable">clazz2</span> <span class="hljs-operator">=</span> ECFieldElement.Fp.class;<br><br>			<span class="hljs-type">Constructor</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> clazz2.getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;BigInteger.class, BigInteger.class, BigInteger.class&#125;);<br>			c2.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//		this.ecc_gx_fieldelement = new Fp(this.ecc_p, this.ecc_gx);</span><br>			<span class="hljs-comment">// 此区间的bcprov版本的构造方法是私有的，无法直接new，只能通过反射来获取对象</span><br>			<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> calculateResidue(<span class="hljs-built_in">this</span>.ecc_p);<br>			<span class="hljs-built_in">this</span>.ecc_gx_fieldelement = (ECFieldElement.Fp)c2.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.ecc_p, r, <span class="hljs-built_in">this</span>.ecc_gx&#125;);<br>			<span class="hljs-comment">// 此区间的bcprov版本的构造方法是私有的，无法直接new，只能通过反射来获取对象</span><br><span class="hljs-comment">//		this.ecc_gy_fieldelement = new Fp(this.ecc_p, this.ecc_gy);</span><br>			<span class="hljs-built_in">this</span>.ecc_gy_fieldelement = (ECFieldElement.Fp)c2.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.ecc_p, r, <span class="hljs-built_in">this</span>.ecc_gy&#125;);<br><br>			<span class="hljs-built_in">this</span>.ecc_curve = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECCurve</span>.Fp(<span class="hljs-built_in">this</span>.ecc_p, <span class="hljs-built_in">this</span>.ecc_a, <span class="hljs-built_in">this</span>.ecc_b);<br><br><span class="hljs-comment">//		this.ecc_point_g = new ECPoint.Fp(this.ecc_curve, this.ecc_gx_fieldelement, this.ecc_gy_fieldelement);</span><br>			ecc_point_g1 = (ECPoint.Fp)c1.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_gx_fieldelement, <span class="hljs-built_in">this</span>.ecc_gy_fieldelement&#125;);<br>		&#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>			e.printStackTrace();<br>		&#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br><br>		<span class="hljs-built_in">this</span>.ecc_point_g = ecc_point_g1;<br>		<span class="hljs-built_in">this</span>.ecc_bc_spec = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECDomainParameters</span>(<span class="hljs-built_in">this</span>.ecc_curve, <span class="hljs-built_in">this</span>.ecc_point_g, <span class="hljs-built_in">this</span>.ecc_n);<br><br>		ECKeyGenerationParameters ecc_ecgenparam;<br>		ecc_ecgenparam = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyGenerationParameters</span>(<span class="hljs-built_in">this</span>.ecc_bc_spec, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandom</span>());<br><br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ECKeyPairGenerator</span>();<br>		<span class="hljs-built_in">this</span>.ecc_key_pair_generator.init(ecc_ecgenparam);<br>	&#125;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * 计算Residue</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> p</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BigInteger <span class="hljs-title function_">calculateResidue</span><span class="hljs-params">(BigInteger p)</span><br>	&#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">bitLength</span> <span class="hljs-operator">=</span> p.bitLength();<br>		<span class="hljs-keyword">if</span> (bitLength &gt;= <span class="hljs-number">96</span>)<br>		&#123;<br>			<span class="hljs-type">BigInteger</span> <span class="hljs-variable">firstWord</span> <span class="hljs-operator">=</span> p.shiftRight(bitLength - <span class="hljs-number">64</span>);<br>			<span class="hljs-keyword">if</span> (firstWord.longValue() == -<span class="hljs-number">1L</span>)<br>			&#123;<br>				<span class="hljs-keyword">return</span> ECConstants.ONE.shiftLeft(bitLength).subtract(p);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] sm2GetZ(<span class="hljs-type">byte</span>[] userId, ECPoint userKey)<br>	&#123;<br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br><br>		<span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> userId.length * <span class="hljs-number">8</span>;<br>		sm3.update((<span class="hljs-type">byte</span>) (len &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update((<span class="hljs-type">byte</span>) (len &amp; <span class="hljs-number">0xFF</span>));<br>		sm3.update(userId, <span class="hljs-number">0</span>, userId.length);<br><br>		<span class="hljs-type">byte</span>[] p = Util.byteConvert32Bytes(ecc_a);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_b);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gx);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(ecc_gy);<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.normalize().getXCoord().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		p = Util.byteConvert32Bytes(userKey.normalize().getYCoord().toBigInteger());<br>		sm3.update(p, <span class="hljs-number">0</span>, p.length);<br><br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[sm3.getDigestSize()];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> md;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Sign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, BigInteger userD, ECPoint userKey, SM2Result sm2Result)</span><br>	&#123;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">kp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>		<span class="hljs-keyword">do</span><br>		&#123;<br>			<span class="hljs-keyword">do</span><br>			&#123;<br>				<span class="hljs-comment">// 正式环境</span><br>				<span class="hljs-type">AsymmetricCipherKeyPair</span> <span class="hljs-variable">keypair</span> <span class="hljs-operator">=</span> ecc_key_pair_generator.generateKeyPair();<br>				<span class="hljs-type">ECPrivateKeyParameters</span> <span class="hljs-variable">ecpriv</span> <span class="hljs-operator">=</span> (ECPrivateKeyParameters) keypair.getPrivate();<br>				<span class="hljs-type">ECPublicKeyParameters</span> <span class="hljs-variable">ecpub</span> <span class="hljs-operator">=</span> (ECPublicKeyParameters) keypair.getPublic();<br>				k = ecpriv.getD();<br>				kp = ecpub.getQ();<br><br>				<span class="hljs-comment">// 国密规范测试 随机数k</span><br><span class="hljs-comment">//				String kS = &quot;6CB28D99385C175C94F94E934817663FC176D925DD72B727260DBAAE1FB2F96F&quot;;</span><br><span class="hljs-comment">//				k = new BigInteger(kS, 16);</span><br><span class="hljs-comment">//				kp = this.ecc_point_g.multiply(k);</span><br><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点X1: &quot; + kp.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;计算曲线点Y1: &quot; + kp.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//				System.out.println(&quot;&quot;);</span><br><br>				<span class="hljs-comment">// r</span><br>				r = e.add(kp.normalize().getXCoord().toBigInteger());<br>				r = r.mod(ecc_n);<br>			&#125; <span class="hljs-keyword">while</span> (r.equals(BigInteger.ZERO) || r.add(k).equals(ecc_n));<br><br>			<span class="hljs-comment">// (1 + dA)~-1</span><br>			<span class="hljs-type">BigInteger</span> <span class="hljs-variable">da_1</span> <span class="hljs-operator">=</span> userD.add(BigInteger.ONE);<br>			da_1 = da_1.modInverse(ecc_n);<br><br>			<span class="hljs-comment">// s</span><br>			s = r.multiply(userD);<br>			s = k.subtract(s).mod(ecc_n);<br>			s = da_1.multiply(s).mod(ecc_n);<br>		&#125; <span class="hljs-keyword">while</span> (s.equals(BigInteger.ZERO));<br><br>		sm2Result.r = r;<br>		sm2Result.s = s;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sm2Verify</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] md, ECPoint userKey, BigInteger r, BigInteger s, SM2Result sm2Result)</span><br>	&#123;<br>		sm2Result.R = <span class="hljs-literal">null</span>;<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, md);<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> r.add(s).mod(ecc_n);<br>		<span class="hljs-keyword">if</span>(t.equals(BigInteger.ZERO))<br>		&#123;<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			<span class="hljs-type">ECPoint</span> <span class="hljs-variable">x1y1</span> <span class="hljs-operator">=</span> ecc_point_g.multiply(sm2Result.s);<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X0: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y0: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br><br>			x1y1 = x1y1.add(userKey.multiply(t));<br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点X1: &quot; + x1y1.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;计算曲线点Y1: &quot; + x1y1.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//			System.out.println(&quot;&quot;);</span><br>			sm2Result.R = e.add(x1y1.normalize().getXCoord().toBigInteger()).mod(ecc_n);<br><span class="hljs-comment">//			System.out.println(&quot;R: &quot; + sm2Result.R.toString(16));</span><br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244</span><br></code></pre></td></tr></table></figure>

<h5 id="SM2Utils-4"><a href="#SM2Utils-4" class="headerlink" title="SM2Utils"></a>SM2Utils</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.logging.Log;<br><span class="hljs-keyword">import</span> org.apache.commons.logging.LogFactory;<br><span class="hljs-keyword">import</span> org.bouncycastle.asn1.*;<br><span class="hljs-keyword">import</span> org.bouncycastle.math.ec.ECPoint;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.math.BigInteger;<br><span class="hljs-keyword">import</span> java.util.Enumeration;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SM2Utils</span><br>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(SM2Utils.class);<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] encrypt(<span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] data) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span> || data.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[data.length];<br>		System.arraycopy(data, <span class="hljs-number">0</span>, source, <span class="hljs-number">0</span>, data.length);<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> cipher.Init_enc(sm2, userKey);<br>		cipher.Encrypt(source);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br><br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1Integer</span>(c1.normalize().getXCoord().toBigInteger());<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1Integer</span>(c1.normalize().getYCoord().toBigInteger());<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derDig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(c3);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">derEnc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DEROctetString</span>(source);<br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v.add(x);<br>		v.add(y);<br>		v.add(derDig);<br>		v.add(derEnc);<br>		<span class="hljs-type">DERSequence</span> <span class="hljs-variable">seq</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v);<br>		<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// 此区间的bcprov版本的构造方法是私有的，无法直接new，只能通过反射来调用构造方法</span><br>			<span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ASN1OutputStream.class;<br>			<span class="hljs-type">Constructor</span> <span class="hljs-variable">c4</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;OutputStream.class&#125;);<br>			c4.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//			ASN1OutputStream dos = new ASN1OutputStream(bos);</span><br>			<span class="hljs-type">ASN1OutputStream</span> <span class="hljs-variable">dos</span> <span class="hljs-operator">=</span> (ASN1OutputStream) c4.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;bos&#125;);<br>			dos.writeObject(seq);<br>			<span class="hljs-keyword">return</span> bos.toByteArray();<br>		&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decrypt(<span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] encryptedData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (encryptedData == <span class="hljs-literal">null</span> || encryptedData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">byte</span>[] enc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptedData.length];<br>		System.arraycopy(encryptedData, <span class="hljs-number">0</span>, enc, <span class="hljs-number">0</span>, encryptedData.length);<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-number">1</span>, privateKey);<br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(enc);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object替换DERObject，ASN1Integer替换DERInteger</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// ASN1Sequence asn1 = (ASN1Sequence) derObj;</span><br>		<span class="hljs-comment">// DERInteger x = (DERInteger) asn1.getObjectAt(0);</span><br>		<span class="hljs-comment">// DERInteger y = (DERInteger) asn1.getObjectAt(1);</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		<span class="hljs-type">ASN1Sequence</span> <span class="hljs-variable">asn1</span> <span class="hljs-operator">=</span> (ASN1Sequence) derObj;<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">0</span>);<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (ASN1Integer) asn1.getObjectAt(<span class="hljs-number">1</span>);<br>		<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> sm2.ecc_curve.createPoint(x.getValue(), y.getValue());<br><br>		<span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cipher</span>();<br>		cipher.Init_dec(userD, c1);<br>		<span class="hljs-type">DEROctetString</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (DEROctetString) asn1.getObjectAt(<span class="hljs-number">3</span>);<br>		enc = data.getOctets();<br>		cipher.Decrypt(enc);<br>		<span class="hljs-type">byte</span>[] c3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		cipher.Dofinal(c3);<br>		<span class="hljs-keyword">return</span> enc;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] sign(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] privateKey, <span class="hljs-type">byte</span>[] sourceData) <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (privateKey == <span class="hljs-literal">null</span> || privateKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">userD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(privateKey);<br><span class="hljs-comment">//		System.out.println(&quot;userD: &quot; + userD.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_point_g.multiply(userD);<br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点X: &quot; + userKey.getX().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;椭圆曲线点Y: &quot; + userKey.getY().toBigInteger().toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要Z: &quot; + Util.getHexString(z));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//		System.out.println(&quot;M: &quot; + Util.getHexString(sourceData));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2.sm2Sign(md, userD, userKey, sm2Result);<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">d_r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1Integer</span>(sm2Result.r);<br>		<span class="hljs-type">ASN1Integer</span> <span class="hljs-variable">d_s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1Integer</span>(sm2Result.s);<br><span class="hljs-comment">//		BigInteger d_r = sm2Result.r;</span><br><span class="hljs-comment">//		BigInteger d_s = sm2Result.s;</span><br>		<span class="hljs-type">ASN1EncodableVector</span> <span class="hljs-variable">v2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1EncodableVector</span>();<br>		v2.add(d_r);<br>		v2.add(d_s);<br>		<span class="hljs-comment">// 调整DER编码的写法</span><br>		<span class="hljs-comment">// DERObject sign = new DERSequence(v2);</span><br>		<span class="hljs-comment">// byte[] signdata = sign.getDEREncoded();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">sign</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DERSequence</span>(v2);<br>		<span class="hljs-type">byte</span>[] signdata = sign.getEncoded(<span class="hljs-string">&quot;DER&quot;</span>);<br>		<br>		<span class="hljs-keyword">return</span> signdata;<br>	&#125;<br><br>	<span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifySign</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] userId, <span class="hljs-type">byte</span>[] publicKey, <span class="hljs-type">byte</span>[] sourceData, <span class="hljs-type">byte</span>[] signData)</span> <span class="hljs-keyword">throws</span> IOException<br>	&#123;<br>		<span class="hljs-keyword">if</span> (publicKey == <span class="hljs-literal">null</span> || publicKey.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sourceData == <span class="hljs-literal">null</span> || sourceData.length == <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-type">SM2</span> <span class="hljs-variable">sm2</span> <span class="hljs-operator">=</span> SM2.Instance();<br>		<span class="hljs-type">ECPoint</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> sm2.ecc_curve.decodePoint(publicKey);<br><br>		<span class="hljs-type">SM3Digest</span> <span class="hljs-variable">sm3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM3Digest</span>();<br>		<span class="hljs-type">byte</span>[] z = sm2.sm2GetZ(userId, userKey);<br>		sm3.update(z, <span class="hljs-number">0</span>, z.length);<br>		sm3.update(sourceData, <span class="hljs-number">0</span>, sourceData.length);<br>		<span class="hljs-type">byte</span>[] md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">32</span>];<br>		sm3.doFinal(md, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">if</span> (log.isDebugEnabled())&#123;<br>			log.debug(<span class="hljs-string">&quot;SM3摘要值: &quot;</span> + Util.getHexString(md));<br>		&#125;<br><span class="hljs-comment">//		System.out.println(&quot;SM3摘要值: &quot; + Util.getHexString(md));</span><br><span class="hljs-comment">//		System.out.println();</span><br><br>		<span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(signData);<br>		<span class="hljs-type">ASN1InputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ASN1InputStream</span>(bis);<br>		<span class="hljs-comment">// 使用ASN1Object替换DERObject，ASN1Integer替换DERInteger</span><br>		<span class="hljs-comment">// DERObject derObj = dis.readObject();</span><br>		<span class="hljs-comment">// Enumeration&lt;DERInteger&gt; e = ((ASN1Sequence) derObj).getObjects();</span><br>		<span class="hljs-type">ASN1Object</span> <span class="hljs-variable">derObj</span> <span class="hljs-operator">=</span> (ASN1Object) dis.readObject();<br>		Enumeration&lt;ASN1Integer&gt; e = ((ASN1Sequence) derObj).getObjects();<br>		<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">BigInteger</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> e.nextElement().getValue();<br>		<span class="hljs-type">SM2Result</span> <span class="hljs-variable">sm2Result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SM2Result</span>();<br>		sm2Result.r = r;<br>		sm2Result.s = s;<br><span class="hljs-comment">//		System.out.println(&quot;r: &quot; + sm2Result.r.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;s: &quot; + sm2Result.s.toString(16));</span><br><span class="hljs-comment">//		System.out.println(&quot;&quot;);</span><br><br><br>		sm2.sm2Verify(md, userKey, sm2Result.r, sm2Result.s, sm2Result);<br>		<span class="hljs-keyword">return</span> sm2Result.r.equals(sm2Result.R);<br>	&#125;<br><br>&#125;<br><span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虽然贴了很多代码，但是如果用对比工具看的话，实际改动的代码也就二三十行而已，主要是高版本的方法稍微改了，还有个别方法无法直接使用，需要用反射来调用，仅此而已。<br>当然，除了上述的代码调整外，还可以使用第三方工具包，比如hutool，不过也是需要注意hutool也有适用的bcprov版本；还有方法是隔离jar包加载，让特定的类加载特定版本的jar包版本，这两种方式如果想看的也可以评论区提出。</p>
<p>感谢各位大佬的阅读，还望动动小手，一键三连就行了，给博主一点创作的动力。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>java bcprov 国密 依赖 jar包 版本 升级 降级 教程</div>
      <div>https://yhao521.github.io/2025/07/23/摘录/java bcprov 国密 依赖 jar包 版本 升级 降级 教程/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>yhao521</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/23/%E6%91%98%E5%BD%95/git%20submodule%E4%BD%BF%E7%94%A8%EF%BC%88%E6%B7%BB%E5%8A%A0%E5%AD%90%E4%BB%93%E5%BA%93%EF%BC%8C%E5%88%A0%E9%99%A4%E5%AD%90%E4%BB%93%E5%BA%93%EF%BC%8C%E6%9B%B4%E6%96%B0%E5%AD%90%E4%BB%93%E5%BA%93%EF%BC%89/" title="git submodule使用（添加子仓库，删除子仓库，更新子仓库）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">git submodule使用（添加子仓库，删除子仓库，更新子仓库）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/23/%E6%91%98%E5%BD%95/rgthree-comfy%E8%AE%A9ComfyUI%E6%9B%B4%E5%8A%A0%E8%88%92%E9%80%82%E7%9A%84%E6%89%A9%E5%B1%95%E8%8A%82%E7%82%B9%E5%92%8C%E5%8A%9F%E8%83%BD%E9%9B%86/" title="rgthree-comfy:让ComfyUI更加舒适的扩展节点和功能集">
                        <span class="hidden-mobile">rgthree-comfy:让ComfyUI更加舒适的扩展节点和功能集</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>  
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
